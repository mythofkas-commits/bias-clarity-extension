name: CI

on:
  push: { branches: [main, develop] }
  pull_request: { branches: [main, develop] }

permissions: { contents: read }

jobs:
  test-server:
    runs-on: ubuntu-latest
    defaults: { run: { working-directory: server } }
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: 20, cache: 'npm', cache-dependency-path: 'server/package-lock.json' }
      - name: Install deps (tolerate no lockfile)
        run: npm ci || npm install
      - name: Lint (optional)
        run: npm run lint --if-present || echo "no lint script"
      - name: Test (optional, pass with no tests)
        run: npm test --if-present --silent || echo "no tests"
      - name: Build (optional)
        run: npm run build --if-present || echo "no build script"

  lint-extension:
    runs-on: ubuntu-latest
    defaults: { run: { working-directory: extension } }
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: 20, cache: 'npm', cache-dependency-path: 'extension/package-lock.json' }
      - run: npm ci || echo "no deps"
      - run: npm run lint --if-present || echo "no lint"

  build-extension:
    runs-on: ubuntu-latest
    needs: [test-server, lint-extension]
    steps:
      - uses: actions/checkout@v4
      - name: Validate manifest JSON
        run: jq empty extension/manifest.json
      - name: Package extension
        run: |
          cd extension
          zip -r ../extension.zip . -x "node_modules/*" -x ".git/*"
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: extension.zip
          path: extension.zip
          retention-days: 30
